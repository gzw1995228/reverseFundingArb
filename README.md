# 资金费率套利监控系统

监控币安、OKX、Bybit、MEXC、Bitget、Gate.io六大交易所的USDT合约资金费率，基于实际结算时间戳智能分析套利机会，通过企业微信推送通知。

## 功能特点

- 支持6大主流交易所：Binance、OKX、Bybit、MEXC、Bitget、Gate.io
- 实时监控所有USDT合约的资金费率和价格
- 自动获取各交易所真实的下次结算时间戳
- **基于时间戳分析**：按实际结算时间点计算累计费率
- **精确计算**：考虑每个交易所会结算几次
- **统一阈值**：0.4%，简单明了
- 每10秒更新一次数据

## 核心算法

### 1. 收集结算时间戳

对于每个币种，收集所有交易所的下次结算时间戳，从小到大排序。

**示例：BTCUSDT**
```
币安：1769515200000（16:00:00）
OKX：1769515200000（16:00:00）
Gate：1769504400000（13:00:00）

排序：[1769504400000, 1769515200000]
```

### 2. 对每个时间戳分析

对于每个时间戳，计算各交易所到该时间点的累计费率。

### 3. 计算累计费率

**规则：**
- 如果交易所的下次结算时间 ≤ 目标时间：计算会结算几次
- 如果交易所的下次结算时间 > 目标时间：费率为0（还未结算）

**公式：**
```
结算次数 = 1 + floor((目标时间 - 下次结算时间) / 结算周期)
累计费率 = 单次费率 × 结算次数
净收益 = (高累计费率 - 低累计费率) - 价差比
```

## 计算示例

**当前时间：** 12:00:00

**数据：**
- 币安 BTCUSDT：0.08%费率，8h周期，下次结算16:00（4小时后）
- Gate BTCUSDT：-0.5%费率，1h周期，下次结算13:00（1小时后）

**分析目标时间 = 16:00（4小时后）：**

```
币安：
- 下次结算 16:00 ≤ 目标时间 16:00
- 结算次数 = 1
- 累计费率 = 0.08% × 1 = 0.08%

Gate：
- 下次结算 13:00 ≤ 目标时间 16:00
- 从13:00到16:00 = 3小时
- 结算次数 = 1 + floor(3h / 1h) = 4次
- 累计费率 = -0.5% × 4 = -2%

净收益 = (0.08% - (-2%)) - 价差 = 2.08% - 价差
阈值 = 0.4%

如果净收益 > 0.4%，触发通知！✅
```

**关键点：**
- Gate在4小时内会结算4次，累计-2%
- 币安在4小时内只结算1次，累计0.08%
- 存在巨大的套利空间！

详见 [计算示例v4.md](计算示例v4.md) 文档。

## 安装依赖

```bash
go mod download
```

## 配置

设置企业微信机器人webhook地址：

### Windows (CMD)
```cmd
set WECHAT_WEBHOOK=https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=YOUR_KEY
```

### Windows (PowerShell)
```powershell
$env:WECHAT_WEBHOOK="https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=YOUR_KEY"
```

### Linux/Mac
```bash
export WECHAT_WEBHOOK=https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=YOUR_KEY
```

## 运行

```bash
go run .
```

## 微信通知格式

```
🔔 发现 X 个套利机会

【BTCUSDT】
目标时间: 01-27 16:00 (4.00小时后)
净收益: 1.86% (阈值: 0.40%)
高费率: 币安 0.08% × 1次 = 0.08%
低费率: Gate -0.50% × 4次 = -2.00%
价差比: 0.22%
价格: 45000.0000 / 45100.0000
```

**说明：**
- 目标时间：建议平仓时间
- 距离时间：持仓时长
- 结算次数：到目标时间会结算几次
- 累计费率：单次费率 × 结算次数

## 注意事项

- 资金费率结算时间因交易所和合约而异
- 程序每小时自动更新一次结算时间信息
- 基于实际结算时间戳进行精确计算
- 统一阈值：0.4%
- 必须在目标时间前平仓
- 实际套利需要考虑交易手续费、滑点、资金转移成本等
- 建议在实际操作前进行充分的风险评估
- API请求频率请遵守各交易所的限制规则

## 自定义配置

### 修改阈值

编辑 `monitor.go` 中的 `getThresholdByInterval` 函数：

```go
func (m *Monitor) getThresholdByInterval(interval float64) float64 {
	return 0.004 // 0.4%，可以修改这里
}
```
