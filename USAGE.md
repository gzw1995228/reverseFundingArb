# 使用说明

## 快速开始

### 1. 配置企业微信机器人

```cmd
set WECHAT_WEBHOOK=https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=YOUR_KEY
```

### 2. 测试微信推送（可选）

```cmd
go run test_wechat.go wechat.go
```

如果收到测试消息，说明配置成功！

### 3. 运行监控程序

```cmd
go run .
```

或使用脚本：
```cmd
run.bat
```

## 程序输出示例

```
2026/01/27 10:00:00 警告: 未配置WECHAT_WEBHOOK环境变量，将无法发送微信通知
2026/01/27 10:00:00 正在初始化，获取所有交易所的资金费率结算周期...
2026/01/27 10:00:01 Binance 初始化成功
2026/01/27 10:00:01 OKX 初始化成功
2026/01/27 10:00:01 Bybit 初始化成功
2026/01/27 10:00:01 MEXC 初始化成功
2026/01/27 10:00:01 Bitget 初始化成功
2026/01/27 10:00:01 初始化完成，开始监控...
2026/01/27 10:00:02 Binance 获取到 245 个合约
2026/01/27 10:00:02 OKX 获取到 198 个合约
2026/01/27 10:00:02 Bybit 获取到 312 个合约
2026/01/27 10:00:02 MEXC 获取到 156 个合约
2026/01/27 10:00:02 Bitget 获取到 203 个合约
2026/01/27 10:00:02 已发送微信通知，包含 3 个套利机会
```

## 微信通知示例

当发现套利机会时，你会收到类似这样的消息：

```
🔔 发现 3 个套利机会

【BTCUSDT】
净收益: 0.45% (阈值: 0.40%)
高费率: Binance 0.10% (8h)
低费率: OKX -0.05% (8h)
价差比: -0.30%
价格: 45000.0000 / 45100.0000

【ETHUSDT】
净收益: 0.52% (阈值: 0.40%)
高费率: Bybit 0.15% (8h)
低费率: Bitget -0.08% (8h)
价差比: -0.29%
价格: 2500.0000 / 2510.0000

【SOLUSDT】
净收益: 0.48% (阈值: 0.40%)
高费率: MEXC 0.12% (8h)
低费率: OKX -0.10% (8h)
价差比: -0.26%
价格: 150.0000 / 150.5000
```

## 套利逻辑说明

### 计算公式

1. **价差比 (Price_Spread)**
   ```
   Price_Spread = (低费率交易所价格 - 高费率交易所价格) / 高费率交易所价格
   ```

2. **净收益 (Net_Profit)**
   ```
   Net_Profit = (高费率 - 低费率) - Price_Spread
   ```

### 示例计算

假设：
- Binance BTCUSDT: 价格 45000, 资金费率 0.10%
- OKX BTCUSDT: 价格 45100, 资金费率 -0.05%

计算：
```
Price_Spread = (45100 - 45000) / 45000 = 0.0022 = 0.22%
Net_Profit = (0.10% - (-0.05%)) - 0.22% = 0.15% - 0.22% = -0.07%
```

这个例子中净收益为负，不会触发通知。

### 套利策略

当 Net_Profit > 0.4% 时：

1. **做多低费率交易所**：在资金费率低的交易所开多单，收取资金费
2. **做空高费率交易所**：在资金费率高的交易所开空单，收取资金费
3. **对冲风险**：两边仓位相同，价格波动风险对冲
4. **收益来源**：资金费率差 - 价差成本

### 注意事项

⚠️ **实际操作前请注意：**

1. **交易成本**
   - 开仓手续费（通常 0.02% - 0.05%）
   - 平仓手续费
   - 滑点成本

2. **资金成本**
   - 跨交易所转账时间
   - 转账手续费
   - 资金占用成本

3. **风险因素**
   - 极端行情下可能爆仓
   - 交易所可能调整资金费率
   - 流动性不足导致无法成交
   - 交易所系统故障

4. **建议**
   - 从小资金开始测试
   - 设置止损
   - 监控持仓风险
   - 及时平仓

## 高级配置

### 修改监控阈值

编辑 `main.go` 第17行：
```go
monitor := NewMonitor(webhookURL, 0.005) // 改为 0.5%
```

### 修改监控频率

编辑 `main.go` 第27行：
```go
ticker := time.NewTicker(30 * time.Second) // 改为30秒
```

### 只监控特定币种

可以在 `monitor.go` 的 `analyzeArbitrage` 函数中添加过滤：

```go
// 只监控BTC、ETH、SOL
allowedSymbols := map[string]bool{
    "BTCUSDT": true,
    "ETHUSDT": true,
    "SOLUSDT": true,
}

for symbol, exchanges := range symbolMap {
    if !allowedSymbols[symbol] {
        continue
    }
    // ... 其余代码
}
```

## 故障排查

### 1. 获取数据失败

如果看到类似错误：
```
Binance 获取数据失败: Get "https://fapi.binance.com/...": dial tcp: i/o timeout
```

可能原因：
- 网络连接问题
- 需要使用代理
- 交易所API限流

解决方法：
- 检查网络连接
- 配置代理（如需要）
- 降低请求频率

### 2. 未收到通知

检查清单：
- [ ] WECHAT_WEBHOOK 环境变量已设置
- [ ] Webhook地址正确
- [ ] 机器人已添加到群聊
- [ ] 程序日志中没有错误

### 3. 数据不准确

- 不同交易所的symbol格式可能不同
- 某些交易所可能返回空数据
- 建议对比交易所官网数据验证

## 性能优化

### 减少API请求

如果遇到限流，可以：
1. 增加监控间隔（如改为30秒）
2. 只监控主流币种
3. 使用WebSocket代替REST API（需要修改代码）

### 降低内存占用

程序会缓存所有合约数据，如果内存占用过高：
1. 过滤掉交易量小的合约
2. 只保留最近的数据

## 扩展功能

### 添加新的交易所

1. 创建新文件 `exchange_xxx.go`
2. 实现 `Exchange` 接口
3. 在 `monitor.go` 的 `NewMonitor` 中添加

### 添加数据库存储

可以将套利机会保存到数据库：
1. 安装数据库驱动（如 `github.com/lib/pq` for PostgreSQL）
2. 在 `monitor.go` 中添加数据库写入逻辑

### 添加Web界面

可以使用 Gin 框架添加Web界面：
1. 安装 `github.com/gin-gonic/gin`
2. 创建API端点展示实时数据
3. 添加前端页面

## 法律声明

本程序仅供学习和研究使用。使用本程序进行实际交易的风险由使用者自行承担。作者不对任何交易损失负责。

请遵守各交易所的API使用条款和当地法律法规。
